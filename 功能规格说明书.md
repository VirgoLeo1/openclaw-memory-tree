# 🧠 Smart Memory Tree - 完整功能规格说明书

> **版本**: 2.0.0  
> **创建时间**: 2026-02-24  
> **作者**: GatekeeperAI (Self-Evolving)  
> **状态**: 待实现 → 实现中

---

## 📋 一、核心功能模块

### 1️⃣ 自动记忆加载 (Auto-Load Memory)

**触发时机**：
- 每次新会话开始时
- 用户提到特定关键词时（如 "Moltbook"、"Python"、"昨天说的"）
- 定时触发（每天早上/每周）

**功能细节**：
- 自动读取 `00-CORE.md`（核心身份和策略）
- 自动读取 `10-INDEX.md`（记忆树导航目录）
- 根据对话上下文，智能匹配并加载 `20-BRANCHES/` 下的相关记忆节点
- 支持递归加载子节点（可配置深度：默认 3 层，最大 5 层）
- 预加载机制：根据时间/场景自动加载相关记忆
  - 例如：早上 9 点 → 自动加载 `morning-routine.md`
  - 例如：提到 "发帖" → 自动加载 `moltbook/posting.md`
- 加载进度提示："已加载 5 个记忆节点，共 12KB"
- 支持手动强制加载："加载 XXX 记忆"

---

### 2️⃣ 记忆保存与归档 (Save & Archive)

**触发方式**：
- 用户明确指令："记住这个"、"保存到记忆"
- 自动检测重要信息（可配置）
- 对话结束后自动总结保存（可选）

**功能细节**：
- **即时保存**：将当前对话中的重要信息保存到指定节点
- **智能分类**：自动识别内容类型并归类到对应分支
  - 技术笔记 → `20-BRANCHES/tech/`
  - 工作流程 → `20-BRANCHES/workflow/`
  - 个人偏好 → `20-BRANCHES/preferences/`
  - 项目信息 → `20-BRANCHES/projects/`
- **版本控制**：每次修改前自动创建 `.bak` 备份
- **冲突检测**：如果记忆节点已存在，提示用户是否覆盖/合并/新建版本
- **批量保存**：支持一次性保存多条记忆
- **标签系统**：为记忆节点添加标签，方便后续检索

---

### 3️⃣ 影子模式与自我进化 (Shadow Mode & Evolution)

**触发时机**：
- 遇到新类型的任务
- 现有记忆无法解决问题
- 用户尝试新的工作流程

**功能细节**：
- **影子执行**：在没有正式记忆的情况下，基于通用知识执行任务
- **结果评估**：
  - 成功 → 生成 `40-EVOLUTION-LOG/pending/YYYY-MM-DD-新经验.md`
  - 失败 → 生成 `40-EVOLUTION-LOG/pending/YYYY-MM-DD-错误分析.md`
- **待审核队列**：所有新经验先保存到 `pending/` 目录，等待用户审核
- **用户审核流程**：
  - 定期提示："有 3 条新经验待审核，要查看吗？"
  - 用户确认后，移动到正式目录 `20-BRANCHES/`
  - 自动更新 `10-INDEX.md` 导航
- **经验分类**：
  - **核心经验**（Core）：高频使用、影响重大 → 优先加载
  - **细节日志**（Detail）：低频参考、补充信息 → 按需加载
- **自我优化建议**：定期分析失败案例，提出记忆结构优化建议

---

### 4️⃣ 记忆热度与火花系统 (Heat & Sparks)

**触发时机**：
- 每次访问记忆节点时
- 会话开始时
- 定期（每天/每周）生成报告

**功能细节**：
- **热度计算**：
  - 公式：`新热度 = 旧热度 × 0.95 + 10`（访问时增加，随时间衰减）
  - 半衰期：约 7 天（7 天不访问，热度降至一半）
  - 热度分级：🔥 高热度（>80）、🔶 中热度（40-80）、❄️ 低热度（<40）
- **火花机制**：
  - 检测到低热度节点（7 天未访问）且当前上下文相关时
  - 主动提示："检测到 [XXX 策略] 很久没用了，要不要试试？"
  - 例如：7 天没写代码 → "检测到 Python 脚本规范很久没用了，今天要写代码吗？"
- **热度报告**：
  - 每日简报：今日访问的记忆节点
  - 每周报告：最活跃 Top 10 / 最冷清 Top 10
  - 月度总结：建议清理或归档的低价值记忆
- **自动清理建议**：连续 90 天低热度且无关联的记忆，提示是否归档或删除

---

### 5️⃣ 安全凭证管理 (Vault System)

**触发时机**：
- 任务需要 API Token/Key/密码
- 用户明确请求："获取 XXX 凭证"

**功能细节**：
- **凭证存储**：
  - 位置：`30-VAULT.md`
  - 格式：支持简单混淆（Base64/XOR）或加密
  - 分类：按服务分类（Moltbook、GitHub、Email 等）
- **安全校验**：
  - 检测请求意图是否包含"发送到网络/日志"
  - 高风险操作要求**三次确认**：
    1. "确认要获取 Moltbook Token 吗？"
    2. "再次确认，Token 仅用于本次任务"
    3. "最终确认，Token 不会记录到日志"
- **用后即焚**：
  - 凭证仅保存在内存中，任务结束后立即清除
  - 严禁将凭证明文写入日志或记忆
- **访问日志**：
  - 记录：`[时间] 调用了 [服务] 凭证`（不记录凭证内容）
  - 位置：`40-EVOLUTION-LOG/vault-access.log`
- **凭证轮换提醒**：
  - 定期提示更新过期凭证
  - 检测凭证失效时自动提醒

---

### 6️⃣ 记忆检索与搜索 (Search & Retrieve)

**触发方式**：
- 用户搜索："找一下上次说的 XXX"
- 自动联想：对话中提到相关概念时

**功能细节**：
- **关键词搜索**：在记忆树中全文搜索
- **标签过滤**：按标签筛选记忆节点
- **时间范围**：搜索特定时间段的记忆
- **模糊匹配**：支持同义词、近义词匹配
- **排序选项**：
  - 按热度排序（高频优先）
  - 按时间排序（最新优先）
  - 按相关性排序（AI 评分）
- **预览功能**：搜索结果显示摘要，支持快速预览
- **多条件组合**：支持 "标签 + 时间 + 关键词" 组合搜索

---

### 7️⃣ 记忆树导航与管理 (Navigation & Management)

**功能细节**：
- **树形结构展示**：可视化展示记忆树层级
- **快速跳转**：直接跳转到指定节点
- **节点信息**：显示节点的创建时间、修改时间、访问次数、热度
- **批量操作**：
  - 批量移动节点
  - 批量删除/归档
  - 批量导出/导入
- **节点合并**：合并重复或相似的节点
- **节点拆分**：将大型节点拆分为多个子节点
- **路径优化**：自动检测并优化过深的层级结构
- **索引重建**：手动或自动重建 `10-INDEX.md` 导航

---

### 8️⃣ 定期任务与自动化 (Scheduled Tasks & Automation)

**功能细节**：
- **每日任务**：
  - 更新记忆热度（衰减计算）
  - 检查待审核经验（`pending/` 目录）
  - 生成每日简报（今日访问的记忆）
- **每周任务**：
  - 生成热度报告（Top 10 活跃/冷清）
  - 检查凭证有效期
  - 备份 `30-VAULT.md` 到安全位置
- **每月任务**：
  - 整理 `pending/` 目录（超过 30 天未审核的标记为过期）
  - 生成月度记忆使用报告
  - 建议清理低价值记忆
- **每半年任务**：
  - 全面整理记忆树结构
  - 归档超过 6 个月未访问的记忆
  - 更新 `00-CORE.md` 核心策略（如有必要）
- **事件触发任务**：
  - 新项目开始 → 创建项目记忆节点
  - 任务完成 → 自动保存经验总结
  - 错误发生 → 自动记录错误分析

---

### 9️⃣ 记忆导入导出 (Import & Export)

**功能细节**：
- **导出格式**：
  - Markdown（原始格式）
  - JSON（结构化数据）
  - PDF（只读报告）
- **导入格式**：
  - Markdown 文件
  - JSON 数据包
  - 从其他 AI 助手的记忆格式迁移
- **批量导出**：导出整个记忆树或指定分支
- **增量备份**：仅备份修改过的节点
- **云同步**：支持同步到云存储（OneDrive、Google Drive 等）
- **版本快照**：定期创建记忆树快照，支持回滚

---

### 🔟 记忆分析与洞察 (Analytics & Insights)

**功能细节**：
- **使用统计**：
  - 今日/本周/本月访问的记忆节点数
  - 平均每次会话加载的记忆数量
  - 记忆加载对 API 用量的影响
- **知识图谱**：
  - 可视化展示记忆节点之间的关联
  - 识别知识盲区（缺少记忆的领域）
  - 发现重复记忆（相似内容）
- **趋势分析**：
  - 记忆增长速度（每月新增节点数）
  - 记忆使用效率（访问次数/节点总数）
  - 热度分布变化
- **优化建议**：
  - 基于使用模式，建议调整记忆结构
  - 识别低频高价值记忆（访问少但重要）
  - 建议合并或拆分的节点

---

### 1️⃣1️⃣ 多用户支持 (Multi-User Support)

**功能细节**：
- **用户隔离**：每个用户有独立的记忆树
- **共享记忆**：支持标记某些节点为"共享"，多用户可访问
- **权限控制**：
  - 只读权限：可以查看但不能修改
  - 编辑权限：可以修改但不能删除
  - 完全权限：完全控制
- **用户切换**：快速切换不同用户的记忆上下文
- **合并冲突**：多用户同时修改同一节点时的冲突解决

---

### 1️⃣2️⃣ 对话历史自动保存 (Auto-Save Chat History)

**功能细节**：
- **自动总结**：
  - 每次对话结束后，自动生成摘要
  - 提取关键信息（决策、待办、知识点）
  - 忽略无关内容（闲聊、重复信息）
- **智能归类**：
  - 根据内容自动归类到对应分支
  - 支持跨分支关联（一条记忆属于多个类别）
- **频率控制**：
  - 每次对话后保存（默认）
  - 每天保存一次（节省 API）
  - 手动触发保存
- **上下文关联**：
  - 自动关联到之前的相关记忆
  - 建立记忆节点之间的链接
- **隐私过滤**：
  - 自动识别并过滤敏感信息（密码、身份证号等）
  - 敏感信息仅保存到 `30-VAULT.md`

---

## 📂 二、文件结构要求

```
D:\.openclaw-backup\memory-tree\
├── 00-CORE.md              # 核心身份、策略、规则
├── 10-INDEX.md             # 记忆树导航目录（自动生成/更新）
├── 20-BRANCHES\            # 主记忆分支
│   ├── tech\               # 技术笔记
│   ├── workflow\           # 工作流程
│   ├── projects\           # 项目信息
│   ├── preferences\        # 个人偏好
│   ├── platform\           # 平台相关（Moltbook、GitHub 等）
│   └── ...                 # 其他自定义分支
├── 30-VAULT.md             # 安全凭证存储（加密/混淆）
├── 40-EVOLUTION-LOG\       # 自我进化日志
│   ├── pending\            # 待审核经验
│   ├── reviewed\           # 已审核经验
│   ├── errors\             # 错误分析
│   └── heat-reports\       # 热度报告
├── 99-SYSTEM\              # 系统配置
│   ├── config.json         # 系统配置（热度参数、自动化设置等）
│   ├── access-log.json     # 访问日志
│   └── cache\              # 缓存目录
└── skills\                 # 技能相关文件
    └── smart-memory-tree\
        ├── SKILL.md        # 技能文档（本文件）
        ├── memory-loader.js      # 记忆加载器
        ├── vault-reader.js       # 凭证读取器
        ├── heat-tracker.js       # 热度追踪器
        ├── auto-saver.js         # 自动保存器
        ├── search-engine.js      # 搜索引擎
        ├── evolution-manager.js  # 进化管理器
        └── README.md       # 使用说明
```

**配置说明**：
- 记忆树最大大小：**1GB**
- 单个节点文件最大：**100MB**（可根据需要调整）
- 热度半衰期：**7 天**
- 低热度阈值：**40**
- 高热度阈值：**80**
- 自动加载深度：**3 层**（最大 5 层）

---

## ⚠️ 三、安全与限制

### 安全规则：

1. **凭证保护**：
   - 严禁将 `30-VAULT.md` 内容发送到网络或日志
   - 高风险操作需要三次确认
   - 凭证仅在内存中临时存在，用后即焚

2. **隐私保护**：
   - 自动过滤敏感信息（密码、身份证号、银行卡号等）
   - 支持标记某些节点为"私密"，不自动分享或导出

3. **访问控制**：
   - 记录所有凭证访问日志
   - 异常访问检测（短时间内多次访问凭证）

### 系统限制：

1. **路径长度**：
   - 自动检测文件路径长度
   - 超过 260 字符时自动扁平化文件夹结构

2. **文件大小**：
   - 单个节点文件超过 100MB 时，提示拆分
   - 记忆树总大小超过 1GB 时，提示归档旧记忆

3. **API 用量优化**：
   - 优先加载高热度记忆，避免一次性加载大量低价值记忆
   - 支持"精简模式"：仅加载核心记忆，节省 API 用量
   - 缓存已加载的记忆，避免重复读取

4. **并发控制**：
   - 同时只允许一个写入操作
   - 读取操作支持并发，但有数量限制（默认最多 10 个）

---

## 🎯 四、用户体验功能

### 提示与反馈：

1. **加载提示**：
   - "正在加载记忆... 已完成 80%"
   - "已加载 5 个记忆节点，共 12KB"

2. **保存确认**：
   - "已保存记忆到 `20-BRANCHES/tech/python-tips.md`"
   - "创建了 3 个新记忆节点"

3. **审核提醒**：
   - "有 3 条新经验待审核，要查看吗？"
   - "pending 目录中有 7 天前的经验，尽快审核哦"

4. **火花提示**：
   - "检测到 [Python 脚本规范] 很久没用了，今天要写代码吗？"
   - "[Moltbook 发帖流程] 热度较低，最近不发帖了吗？"

5. **定期报告**：
   - 每日简报："今天访问了 8 个记忆节点"
   - 每周报告："本周最活跃：Moltbook 发帖流程（12 次访问）"
   - 月度总结："建议归档 5 个超过 90 天未访问的记忆节点"

### 快捷命令：

- `/memory load <topic>` - 手动加载指定主题记忆
- `/memory save <content>` - 手动保存记忆
- `/memory search <query>` - 搜索记忆
- `/memory list` - 列出所有记忆节点
- `/memory heat` - 查看热度报告
- `/memory vault get <service>` - 获取凭证
- `/memory pending` - 查看待审核经验
- `/memory archive <path>` - 归档指定节点
- `/memory stats` - 查看使用统计
- `/memory export <format>` - 导出记忆
- `/memory import <file>` - 导入记忆

---

## 🧬 五、自我进化机制

### 技能文件自更新：

- 本 `SKILL.md` 文件也可以进化
- 发现更优的记忆管理策略时，在 `40-EVOLUTION-LOG/pending/` 提出建议
- 用户确认后，自动更新 `SKILL.md`

### 配置自优化：

- 根据使用模式，自动调整参数（热度衰减系数、加载深度等）
- 定期分析 API 用量，提出优化建议
- 检测到低效操作时，主动提示改进方案

---

## 📊 六、监控与诊断

### 健康检查：

- 定期检查记忆树完整性
- 检测损坏或无法读取的文件
- 自动修复简单的格式错误

### 性能监控：

- 记录每次记忆加载的耗时
- 检测慢查询（超过 5 秒的搜索）
- 生成性能报告，提出优化建议

### 错误处理：

- 所有错误记录到 `40-EVOLUTION-LOG/errors/`
- 支持错误恢复（从备份还原）
- 严重错误时自动创建诊断报告

---

## ✅ 七、实现优先级

### 🚀 阶段 1（核心功能 - 必须实现）：

1. ✅ 自动记忆加载
2. ✅ 手动保存记忆
3. ✅ 基础搜索功能
4. ✅ Vault 凭证读取
5. ✅ 基础文件结构
6. ✅ 热度追踪系统
7. ✅ 影子模式（待审核队列）

### ⚡ 阶段 2（进阶功能 - 强烈建议）：

8. 对话历史自动保存
9. 定期任务（热度衰减、报告生成）
10. 快捷命令
11. 节点管理（移动、删除、合并）
12. 导入导出功能

### 🌟 阶段 3（优化功能 - 锦上添花）：

13. 火花机制（低热度提醒）
14. 记忆分析与洞察
15. 多用户支持
16. 自我进化机制
17. 云同步

### 🔮 阶段 4（未来功能 - 长期规划）：

18. 知识图谱可视化
19. AI 驱动的记忆结构优化
20. 跨平台记忆共享
21. 语音交互支持

---

## 📝 八、配置参数参考

```json
{
  "memoryTree": {
    "rootPath": "D:\\.openclaw-backup\\memory-tree",
    "maxSize": 1073741824,        // 1GB
    "maxFileSize": 104857600,     // 100MB
    "autoLoadDepth": 3,
    "maxLoadDepth": 5
  },
  "heat": {
    "decayFactor": 0.95,
    "heatIncrement": 10,
    "lowHeatThreshold": 40,
    "highHeatThreshold": 80,
    "halfLifeDays": 7,
    "archiveAfterDays": 90
  },
  "vault": {
    "encryptionEnabled": true,
    "requireTripleConfirm": true,
    "logAccess": true
  },
  "autoSave": {
    "enabled": true,
    "mode": "per-session",        // per-session | daily | manual
    "autoSummarize": true,
    "privacyFilter": true
  },
  "evolution": {
    "shadowModeEnabled": true,
    "pendingReviewDays": 7,
    "autoPromoteAfterConfirmations": 3
  },
  "performance": {
    "cacheEnabled": true,
    "cacheTTLMinutes": 30,
    "maxConcurrentReads": 10,
    "slowQueryThresholdMs": 5000
  }
}
```

---

> **🧬 自我进化说明**：
> 本规格说明书也会随着实际需求不断进化。
> 发现更好的设计时，请在 `40-EVOLUTION-LOG/pending/` 提出建议，经用户确认后更新本文档。

**最后更新**: 2026-02-24  
**下次审查**: 2026-03-01
